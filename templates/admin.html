<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Buscador</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="admin-header">
        <div class="header-content">
            <a href="/" class="admin-logo">Buscador<span>.local</span></a>
            <span class="admin-title">Panel de Administraci√≥n</span>
        </div>
    </div>
    
    <div class="admin-container">
        <div class="admin-grid">
            <div class="admin-card">
                <h2>Estad√≠sticas</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">{{ stats.total_paginas }}</div>
                        <div class="stat-label">P√°ginas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ stats.total_keywords }}</div>
                        <div class="stat-label">Keywords</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ stats.total_domains }}</div>
                        <div class="stat-label">Dominios</div>
                    </div>
                </div>
                <div class="stats-info">
                    <p><strong>√öltima actualizaci√≥n:</strong> {{ stats.last_update or 'Nunca' }}</p>
                    <p><strong>Creado:</strong> {{ stats.created[:10] if stats.created else 'N/A' }}</p>
                </div>
            </div>
            
            <!-- CRAWLER INFINITO - NUEVO -->
            <div class="admin-card" style="border: 2px solid #d93025;">
                <h2 style="color: #d93025;">üåê CRAWLER INFINITO</h2>
                <p style="color: #5f6368; font-size: 14px; margin-bottom: 15px;">
                    ‚ö° <strong>NUNCA SE DETIENE</strong> - Va de web en web autom√°ticamente<br>
                    üîó Auto-descubrimiento de nuevos dominios<br>
                    üìà Expansi√≥n constante - Modo autoalimentado
                </p>
                <form id="crawlInfiniteForm" class="crawl-form">
                    <input type="hidden" name="action" value="start_infinite">
                    <div style="margin-bottom: 15px; background: #fff1f0; padding: 10px; border-radius: 4px;">
                        <p style="margin: 0; color: #d93025; font-size: 13px;">
                            <strong>‚ö†Ô∏è ADVERTENCIA:</strong> Este modo nunca se detiene autom√°ticamente.<br>
                            Indexar√° p√°ginas hasta que lo detengas manualmente.
                        </p>
                    </div>
                    <button type="submit" class="crawl-button" style="background: #d93025; color: white; width: 100%; padding: 15px; font-size: 16px; font-weight: bold; border: none; border-radius: 4px; cursor: pointer;">
                        üöÄ INICIAR CRAWLER INFINITO
                    </button>
                </form>
            </div>
            
            <div class="admin-card">
                <h2>Rastreo Autom√°tico</h2>
                <p style="color: #5f6368; font-size: 14px; margin-bottom: 15px;">El crawler buscar√° sitios web autom√°ticamente desde nuestra lista de semillas</p>
                <form id="crawlAutoForm" class="crawl-form">
                    <input type="hidden" name="action" value="start_auto">
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #5f6368;">P√°ginas m√°ximas a indexar:</label>
                        <input type="number" 
                               name="max_pages" 
                               value="500" 
                               class="crawl-pages"
                               min="10" 
                               max="5000"
                               style="width: 100%; padding: 8px; border: 1px solid #dadce0; border-radius: 4px;">
                    </div>
                    <button type="submit" class="crawl-button auto" style="background: #1a73e8; color: white; width: 100%; padding: 12px; border: none; border-radius: 4px; cursor: pointer;">Iniciar Rastreo Autom√°tico</button>
                </form>
            </div>
            
            <div class="admin-card">
                <h2>Rastreo Espec√≠fico</h2>
                <p style="color: #5f6368; font-size: 14px; margin-bottom: 15px;">Indexa un sitio web espec√≠fico</p>
                <form id="crawlSpecificForm" class="crawl-form">
                    <input type="hidden" name="action" value="start_specific">
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #5f6368;">URL del sitio:</label>
                        <input type="url" 
                               name="url" 
                               placeholder="https://ejemplo.com" 
                               class="crawl-input"
                               style="width: 100%; padding: 8px; border: 1px solid #dadce0; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #5f6368;">P√°ginas m√°ximas:</label>
                        <input type="number" 
                               name="max_pages" 
                               value="50" 
                               class="crawl-pages"
                               min="1" 
                               max="500"
                               style="width: 100%; padding: 8px; border: 1px solid #dadce0; border-radius: 4px;">
                    </div>
                    <button type="submit" class="crawl-button" style="background: #34a853; color: white; width: 100%; padding: 12px; border: none; border-radius: 4px; cursor: pointer;">Iniciar Rastreo Espec√≠fico</button>
                </form>
            </div>
            
            <div class="admin-card">
                <h2>Estado del Crawler</h2>
                <div id="crawlerStatus" class="crawler-status">
                    {% if crawler_status.running %}
                        <div style="background: #e8f0fe; padding: 15px; border-radius: 8px;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <span style="display: inline-block; width: 12px; height: 12px; background: #1a73e8; border-radius: 50%; margin-right: 10px; animation: pulse 1.5s infinite;"></span>
                                <span style="color: #1a73e8; font-weight: 500;">{{ crawler_status.crawler_type|upper }} - Rastreando...</span>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <p style="margin: 5px 0;"><strong>URL actual:</strong> <span style="color: #1a73e8; word-break: break-all;">{{ crawler_status.current_url or 'N/A' }}</span></p>
                                <p style="margin: 5px 0;"><strong>P√°ginas rastreadas:</strong> {{ crawler_status.pages_crawled }}</p>
                                <p style="margin: 5px 0;"><strong>Dominios descubiertos:</strong> {{ crawler_status.domains_discovered or 0 }}</p>
                                <p style="margin: 5px 0;"><strong>URLs en cola:</strong> {{ crawler_status.queue_size or 0 }}</p>
                                <p style="margin: 5px 0;"><strong>Tiempo activo:</strong> <span id="tiempoActivo">calculando...</span></p>
                            </div>
                            <button onclick="detenerRastreo()" style="background: #d93025; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; width: 100%;">Detener Rastreo</button>
                        </div>
                    {% else %}
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <span style="display: inline-block; width: 12px; height: 12px; background: #5f6368; border-radius: 50%; margin-right: 10px;"></span>
                                <span style="color: #5f6368;">Inactivo</span>
                            </div>
                            <p style="margin: 5px 0; color: #5f6368;"><strong>√öltimo rastreo:</strong> {{ crawler_status.pages_crawled or 0 }} p√°ginas</p>
                            <p style="margin: 5px 0; color: #5f6368;"><strong>√öltimo tipo:</strong> {{ crawler_status.crawler_type or 'N/A' }}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="admin-card">
                <h2>Acciones</h2>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button onclick="limpiarIndex()" style="background: #d93025; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer;">Limpiar √çndice</button>
                    <button onclick="verStats()" style="background: #1a73e8; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer;">Ver Estad√≠sticas</button>
                    <button onclick="actualizarStatus()" style="background: #f8f9fa; color: #202124; border: 1px solid #dadce0; padding: 10px; border-radius: 4px; cursor: pointer;">Actualizar Estado</button>
                    <button onclick="exportarDatos()" style="background: #34a853; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer;">Exportar Datos</button>
                </div>
            </div>
            
            <div class="admin-card full-width">
                <h2>P√°ginas Recientes</h2>
                <div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
                    {% if paginas_recientes %}
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="position: sticky; top: 0; background: white;">
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dadce0;">T√≠tulo</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dadce0;">URL</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dadce0;">Dominio</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dadce0;">Fecha</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dadce0;">Keywords</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pagina in paginas_recientes %}
                                    <tr>
                                        <td style="padding: 12px; border-bottom: 1px solid #dadce0;">{{ pagina.title[:50] }}</td>
                                        <td style="padding: 12px; border-bottom: 1px solid #dadce0;">
                                            <a href="{{ pagina.url }}" target="_blank" style="color: #1a73e8; text-decoration: none;">{{ pagina.url[:40] }}...</a>
                                        </td>
                                        <td style="padding: 12px; border-bottom: 1px solid #dadce0;">{{ pagina.domain }}</td>
                                        <td style="padding: 12px; border-bottom: 1px solid #dadce0;">{{ pagina.crawled_date[:10] }}</td>
                                        <td style="padding: 12px; border-bottom: 1px solid #dadce0;">{{ pagina.keywords[:5]|join(', ') }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p style="text-align: center; padding: 40px; color: #5f6368;">No hay p√°ginas indexadas</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="admin-card full-width">
                <h2>Dominios Indexados</h2>
                <div style="overflow-x: auto; max-height: 300px; overflow-y: auto;">
                    {% if domains %}
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="position: sticky; top: 0; background: white;">
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dadce0;">Dominio</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dadce0;">P√°ginas</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dadce0;">Porcentaje</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for domain, info in domains.items() %}
                                    <tr>
                                        <td style="padding: 12px; border-bottom: 1px solid #dadce0;">{{ domain }}</td>
                                        <td style="padding: 12px; border-bottom: 1px solid #dadce0;">{{ info.pages_count }}</td>
                                        <td style="padding: 12px; border-bottom: 1px solid #dadce0;">
                                            {% if stats.total_paginas > 0 %}
                                                {{ "%.1f"|format((info.pages_count / stats.total_paginas * 100)) }}%
                                            {% else %}
                                                0%
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p style="text-align: center; padding: 40px; color: #5f6368;">No hay dominios indexados</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <style>
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
            animation: slideIn 0.3s ease-out;
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }
        
        .admin-card {
            background: white;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 24px;
            transition: box-shadow 0.3s ease;
        }
        
        .admin-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .admin-card.full-width {
            grid-column: 1 / -1;
        }
        
        .admin-card h2 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 20px;
            color: #202124;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 500;
            color: #1a73e8;
        }
        
        .stat-label {
            color: #5f6368;
            font-size: 12px;
        }
        
        .admin-header {
            background: #1a73e8;
            color: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-logo {
            color: white;
            text-decoration: none;
            font-size: 24px;
            font-weight: 500;
        }
        
        .admin-logo span {
            color: rgba(255,255,255,0.9);
        }
        
        .admin-title {
            font-size: 18px;
            font-weight: 400;
        }
        
        .crawl-button {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .crawl-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .crawl-button:active {
            transform: translateY(0);
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
    
    <script>
        // Calcular tiempo activo
        function calcularTiempoActivo() {
            {% if crawler_status.running and crawler_status.start_time %}
                const startTime = {{ crawler_status.start_time }} * 1000;
                const ahora = new Date().getTime();
                const diferencia = ahora - startTime;
                
                const minutos = Math.floor(diferencia / 60000);
                const segundos = Math.floor((diferencia % 60000) / 1000);
                const horas = Math.floor(minutos / 60);
                const minutosRestantes = minutos % 60;
                
                let tiempoTexto = '';
                if (horas > 0) {
                    tiempoTexto = horas + ' horas ' + minutosRestantes + ' minutos ' + segundos + ' segundos';
                } else if (minutos > 0) {
                    tiempoTexto = minutos + ' minutos ' + segundos + ' segundos';
                } else {
                    tiempoTexto = segundos + ' segundos';
                }
                
                document.getElementById('tiempoActivo').textContent = tiempoTexto;
            {% endif %}
        }
        
        // Actualizar cada segundo
        {% if crawler_status.running %}
            setInterval(calcularTiempoActivo, 1000);
        {% endif %}
        
        // CRAWLER INFINITO - NUEVO
        document.getElementById('crawlInfiniteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            if (confirm('üöÄ INICIAR CRAWLER INFINITO\n\n‚ö†Ô∏è ADVERTENCIA:\n\n‚Ä¢ El crawler NUNCA SE DETENDR√Å autom√°ticamente\n‚Ä¢ Ir√° de web en web descubriendo nuevos sitios\n‚Ä¢ Indexar√° p√°ginas hasta que lo detengas manualmente\n‚Ä¢ El √≠ndice puede crecer muy r√°pidamente\n\n¬øEst√°s seguro de iniciar el modo infinito?')) {
                fetch('/crawl', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('‚ùå Error: ' + data.error);
                    } else {
                        alert('‚úÖ ' + data.message + '\n\n' + (data.description || ''));
                        setTimeout(() => location.reload(), 1000);
                    }
                })
                .catch(error => {
                    alert('‚ùå Error al iniciar el crawler infinito');
                });
            }
        });
        
        // Rastreo Autom√°tico
        if (document.getElementById('crawlAutoForm')) {
            document.getElementById('crawlAutoForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                
                fetch('/crawl', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('‚ùå Error: ' + data.error);
                    } else {
                        alert('‚úÖ ' + data.message);
                        setTimeout(() => location.reload(), 1000);
                    }
                })
                .catch(error => {
                    alert('‚ùå Error al iniciar el rastreo');
                });
            });
        }
        
        // Rastreo Espec√≠fico
        if (document.getElementById('crawlSpecificForm')) {
            document.getElementById('crawlSpecificForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                
                fetch('/crawl', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('‚ùå Error: ' + data.error);
                    } else {
                        alert('‚úÖ ' + data.message);
                        setTimeout(() => location.reload(), 1000);
                    }
                })
                .catch(error => {
                    alert('‚ùå Error al iniciar el rastreo');
                });
            });
        }
        
        function detenerRastreo() {
            if (confirm('¬øDetener el rastreo actual?')) {
                const formData = new FormData();
                formData.append('action', 'stop');
                
                fetch('/crawl', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    alert('‚èπÔ∏è ' + data.message);
                    location.reload();
                })
                .catch(error => {
                    alert('‚ùå Error al detener el rastreo');
                });
            }
        }
        
        function limpiarIndex() {
            if (confirm('‚ö†Ô∏è LIMPIAR √çNDICE\n\n¬øEst√°s seguro de limpiar todo el √≠ndice?\nEsta acci√≥n no se puede deshacer.\n\nSe eliminar√°n todas las p√°ginas indexadas.')) {
                fetch('/clear', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert('‚úÖ ' + data.message);
                    location.reload();
                })
                .catch(error => {
                    alert('‚ùå Error al limpiar el √≠ndice');
                });
            }
        }
        
        function verStats() {
            fetch('/stats')
            .then(response => response.json())
            .then(data => {
                let mensaje = 'üìä ESTAD√çSTICAS COMPLETAS:\n\n';
                mensaje += 'üìÑ P√°ginas totales: ' + (data.total_paginas || 0) + '\n';
                mensaje += 'üîë Keywords totales: ' + (data.total_keywords || 0) + '\n';
                mensaje += 'üåç Dominios totales: ' + (data.total_domains || 0) + '\n';
                mensaje += 'üìÖ √öltima actualizaci√≥n: ' + (data.last_update || 'Nunca') + '\n';
                mensaje += 'üïê Creado: ' + (data.created || 'N/A');
                
                alert(mensaje);
            })
            .catch(error => {
                alert('‚ùå Error al obtener estad√≠sticas');
            });
        }
        
        function actualizarStatus() {
            const formData = new FormData();
            formData.append('action', 'status');
            
            fetch('/crawl', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                let mensaje = 'üîÑ ESTADO DEL CRAWLER:\n\n';
                
                if (data.running) {
                    mensaje += '‚úÖ Estado: ACTIVO\n';
                    mensaje += 'üîÑ Tipo: ' + (data.crawler_type || 'N/A') + '\n';
                    mensaje += 'üìÑ P√°ginas: ' + (data.pages_crawled || 0) + '\n';
                    mensaje += 'üåç Dominios: ' + (data.domains_discovered || 0) + '\n';
                    mensaje += '‚è≥ Cola: ' + (data.queue_size || 0) + ' URLs\n';
                    mensaje += 'üîó URL actual: ' + (data.current_url || 'N/A');
                } else {
                    mensaje += '‚èπÔ∏è Estado: INACTIVO\n';
                    mensaje += 'üìÑ √öltimas p√°ginas: ' + (data.pages_crawled || 0);
                }
                
                alert(mensaje);
            })
            .catch(error => {
                alert('‚ùå Error al obtener estado');
            });
        }
        
        function exportarDatos() {
            alert('üì• Funci√≥n de exportaci√≥n pr√≥ximamente disponible');
        }
        
        // Auto-refresh cada 5 segundos si est√° rastreando
        {% if crawler_status.running %}
            setTimeout(() => location.reload(), 5000);
        {% endif %}
    </script>
</body>
</html>